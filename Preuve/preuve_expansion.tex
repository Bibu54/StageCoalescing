\documentclass[12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[french]{babel}
\usepackage{amsmath, amssymb}
\usepackage{stmaryrd}


\title{Coalescing - Expansion d'opérateur}
\author{Raphaël Le Bihan}

\newcommand{\defeq}{\ensuremath{\; \hat{=} \;}}
\newcommand{\FOL}{\ensuremath{\textup{\tiny{}FOL}}}
\newcommand{\false}{\textup{ff}}
\newcommand{\true}{\textup{tt}}
\newcommand{\M}{\ensuremath{\mathcal{M}}}

\usepackage{xcolor}
\newcommand{\raph}[1]{\textcolor{red}{#1}}

\begin{document}

\maketitle

On étudie dans ce document le remplacement d'un opérateur par sa définition dans une formule FOML.
On cherche à montrer en particulier que pour un opérateur $d(\vec{x_i}) \triangleq e_d$ et une formule FOML $\phi$, si $\phi$ est valide une fois abstraite en FOL, alors la formule $\widetilde{\phi}$ obtenue en remplaçant chaque occurence de $d(\vec{e_i})$ par $e_d(\vec{e_i}/\vec{x_i})$ est également valide une fois abstraite en FOL.

On cherche alors à établir une correspondance sémantique entre les abstractions FOL de $\phi$ et $\widetilde{\phi}$.
\[
  \phi \to \phi_\FOL
\]
\[
  \phi \to \widetilde{\phi} \to \widetilde{\phi}_\FOL
\]

\raph{%
  (J'effacerai ce schéma ou j'en ferai un mieux, mais pour l'instant il permet de comprendre quelles formules qu'on manipule.)}

\paragraph{Définition} Remplacement d'un opérateur défini\\
Soit $d(\vec{x_i}) \triangleq e_d$ un opérateur défini, et $\phi$ une formule FOML pouvant contenir des occurences de $d$.
On définit récursivement $\widetilde{\phi}$ la formule obtenue en remplaçant $d$ par sa définition dans $\phi$ par :
\begin{align*}
  \widetilde{x} &\defeq x \\
  \widetilde{v} &\defeq v \\
  \widetilde{op(\vec{e_i})} &\defeq op(\vec{\widetilde{e_i}}) \\
  \widetilde{e_1 = e_2} &\defeq \widetilde{e_1} = \widetilde{e_2} \\
  \widetilde{\textup{FALSE}} &\defeq \textup{FALSE} \\
  \widetilde{e_1 \Rightarrow e_2} &\defeq \widetilde{e_1} \Rightarrow \widetilde{e_2} \\
  \widetilde{\forall x : e } &\defeq \forall x : \widetilde{e} \\
  \widetilde{\nabla e} &\defeq \nabla \widetilde{e} \\
  \widetilde{d(\vec{e_i})} &\defeq e_d(\vec{\widetilde{e_i}}/\vec{x_i})
\end{align*}

\raph{%
  Cette définition correspond bien à ce qu'on veut faire.\\
  Remarque 1 : Ici on n'a pas parlé des opérateurs définis autres que d.\\
  Remarque 2 : On ne remplace pas \og{}qu'une fois\fg $d$, mais récursivement.
  Par ex $d(d(e))$ donne $e_d([e_d(e/x)]/x)$ et pas $e_d([d(e)]/x)$.}


\paragraph{Propriété 1}
\label{prop_sem}
Soit $d(\vec{x_i}) \triangleq e_i$ un opérateur défini, et $\phi$ une formule FOML pouvant contenir des occurences de $d$.
Soit $\mathcal{M}$ un modèle FOL où on peut interpréter $\widetilde{\phi}_\FOL$ (çàd les opérateurs générés lors de lors de l'abstraction de $\widetilde{\phi}$ sont interprétés dans ce modèle).
On peut compléter $\mathcal{M}$ en un modèle FOL $\mathcal{M}_d$ où on peut interpréter $\phi_\FOL$ et tel que :
\begin{enumerate}
\item
  $\mathcal{M}_d$ et $\mathcal{M}$ ont même domaine, et même interprétation des opérateurs $op \in \mathcal{O}$ et des opérateurs générés lors de l'abstraction de $\widetilde{\phi}$ ;
\item
  $\mathcal{M}_d$ et $\mathcal{M}$ ont même affectation sur les variables libres de $\widetilde{\phi}_\FOL$ ;
\item
  \raph{On devra donner aux opérateurs \framebox{$\lambda z : \nabla e$} et \framebox{$d_{\vec{\epsilon}}$} générés lors de l'abstraction de $\phi$ une interprétation dans $\mathcal{M}_d$ de sorte que la propriété soit vraie. Cf § suivant}
\end{enumerate}
et vérifiant :
\[
  {\llbracket \widetilde{\phi}_\FOL \rrbracket}_{\mathcal{M}} = {\llbracket \phi_\FOL \rrbracket}_{\mathcal{M}_d}
\]

\raph{%
  Remarque : En fait cette propriété a l'air vraie même en gardant exactement la même affectation dans $\mathcal{M}$ et $\mathcal{M}_d$, et en utilisant dans $\mathcal{M}_d$ une bonne définition pour les opérateurs générés lors de l'abstraction de $\phi$.
  Dans ce cas, la preuve serait plus simple, puisqu'on parlerait DU modèle $\mathcal{M}_d$, et il n'y aurait pas besoin de recombiner plusieurs modèles comme dans les cas de $\Rightarrow$ ou $\forall$.}

\raph{%
  Voici donc les points où je bloque dans ma preuve :
  \begin{itemize}
  \item
    Quelle interprétation donner aux nouveaux opérateurs dans $\mathcal{M}_d$
  \item
    Cas $\nabla e$ et $d(\vec{e_i})$ de la preuve, mais je pense que ces cas seront faisables une fois qu'on saura quelle interprétation donner.
  \end{itemize}}

\paragraph{Interprétation des nouveaux opérateurs dans $\mathcal{M}_d$}
On peut définir :
\begin{itemize}
\item
  Pour tout opérateur $d(\vec{x_i}) = e_d$ son interprétation dans $\mathcal{M}_d$ une fois abstrait :
  \[
    \mathcal{I}_d(\framebox{$d_{\vec{\epsilon}}$}) : \vec{a_i} \in \textup{ dom } \mathcal{M}_d \mapsto
    \llbracket {e_d}_\FOL^{\vec{x_i}} \rrbracket_{\mathcal{M}_d[x_i \mapsto a_i]}
  \]
  On évalue la définition, en affectant à chaque paramètre l'argument correspondant.

  \raph{Remarque sur cette définition :}
  
  Ceci permet ensuite dans la preuve pour le cas $d(\vec{e_i})$ :
  \[
    \llbracket d(\vec{e_i})_\FOL^y \rrbracket_{\mathcal{M}_d} =
    \llbracket {e_d}_\FOL^{\vec{x_i}} \rrbracket_{\mathcal{M}_d[x_i \mapsto \llbracket {e_i}_\FOL^y \rrbracket_{\mathcal{M}_d} ]} =
    \llbracket {e_d}_\FOL^{\vec{x_i}} ({e_i}_\FOL^y/{x_i}) \rrbracket_{\mathcal{M}_d}
  \]
  La première égalité est vraie par définition.\\
  On peut montrer la seconde égalité en utilisant d'un lemme de substitution en FOL.\\
  On devra ensuite montrer que : \raph{ Je bloque ici }
  \[
    \llbracket {e_d}_\FOL^{\vec{x_i}} ({e_i}_\FOL^y/{x_i}) \rrbracket_{\mathcal{M}_d} =
    \llbracket {e_d(e_i/x_i)_\FOL^y} \rrbracket_{\mathcal{M}_d}
  \]
  \raph{Ceci est vrai seulement si on choisit des bonnes interprétations dans $\M_d$ des opérateurs générés pendant l'abstraction de $\phi$.}

  On montre dans la suite un exemple où il faut effectivement avoir défini les bonnes interprétations, car les opérateurs obtenus lors de l'abstraction sont différents : \\
  Opérateur :
  \[ d(x) \triangleq e_d \textup{ où } e_d = \nabla \forall y : y = x \]
  Substitution :
  \[ x \mapsto e = \nabla z \]
  Formules une fois abstraites :
  \[ e_\FOL^z = \framebox{$\lambda z : \nabla z$}(z) \]
  \[ {e_d}_\FOL^x = \framebox{$\lambda x : \nabla \forall y : y = x$}(x) \]
  \[ {e_d(e/x)}_\FOL^z = \framebox{$\lambda z : \nabla \forall y : y = \nabla z$}(z) \]
  Ici, si on donne n'importe quelle interprétation à \framebox{$\lambda z : \nabla z$} et \framebox{$\lambda x : \nabla \forall y : y = x$}, on n'aura pas a priori
  \[
    \llbracket \framebox{$\lambda x : \nabla \forall y : y = x$}(\framebox{$\lambda z : \nabla z$}(z)) \rrbracket_{\M_d}
    =
%    \mathcal{I}(\framebox{$\lambda x : \nabla \forall y : y = x$})(\mathcal{I}(\framebox{$\lambda z : \nabla z$})(a))
%    =
%    \mathcal{I}(\framebox{$\lambda z : \nabla \forall y : y = \nabla z$})(a)
    \llbracket \framebox{$\lambda z : \nabla \forall y : y = \nabla z$}(z) \rrbracket_{\M_d}
  \]
\end{itemize}

\paragraph{Preuve}
\raph{La preuve n'est pas finie, en particulier les cas $\phi = d(\vec{e_i})$ et $\phi = \nabla \psi$.}\\
On montre que la propriété est vraie pour $\phi_\FOL^y$ pour toute liste de variables rigides $y$.
On fait une preuve par récurrence sur $\phi$.
\begin{itemize}
\item
  Cas $\phi = x \; | \; y \; | \; \textup{FALSE}$.
  Il suffit de poser $\mathcal{M}_d = \mathcal{M}$.
\item
  Cas $\phi = (\phi_1 \Rightarrow \phi_2)$.
  Par définition ${\phi}_\FOL^y = {\phi_1}_\FOL^y \Rightarrow {\phi_2}_\FOL^y$ et  $\widetilde{\phi}_\FOL^y = \widetilde{\phi_1}_\FOL^y \Rightarrow \widetilde{\phi_2}_\FOL^y$.
  Par hypothèse de récurrence sur $\phi_1$ et $\phi_2$ il existe $\mathcal{M}_{d1}$ et $\mathcal{M}_{d2}$ vérifiant les hypothèses 1, 2 et 3.
  On pose $\mathcal{M}_d$ qui a même domaine et interprétation des opérateurs que $\mathcal{M}_{d1}$ et $\mathcal{M}_{d2}$, et dont l'affectation $\xi_d$ des variables est défini pour toute variable $x$ (flexible ou rigide) comme :
  \[
    \xi_d(x) = \left \{
      \begin{array}{l l}
        \xi_{d1}(x) & \mbox{ si } x \in fv(\phi_1) \\
        \xi_{d2}(x) & \mbox{ sinon }
      \end{array}
    \right .
  \]
  Alors $\mathcal{M}_d$ vérifie les hypothèses 1, 2 et 3.
  De plus : $\llbracket {\phi_1}_\FOL^y \rrbracket_{\mathcal{M}_{d1}} = \llbracket {\phi_1}_\FOL^y \rrbracket_{\mathcal{M}_{d}}$
  et  $\llbracket {\phi_2}_\FOL^y \rrbracket_{\mathcal{M}_{d2}} = \llbracket {\phi_2}_\FOL^y \rrbracket_{\mathcal{M}_{d}}$.
  Alors : 
  \begin{align*}
    \llbracket \phi_\FOL^y \rrbracket_{\mathcal{M}_d}
    &= \left \{
      \begin{array}{l l}
        \true & \textup{ si }  \llbracket {\phi_1}_\FOL^y \rrbracket_{\mathcal{M}_d} \neq \true \textup{ ou } \llbracket {\phi_2}_\FOL^y \rrbracket_{\mathcal{M}_d} = \true \\
        \false & \textup{ sinon }
      \end{array}
             \right . \\
    &= \left \{
      \begin{array}{l l}
        \true & \textup{ si }  \llbracket {\widetilde{\phi_1}}_\FOL^y \rrbracket_{\mathcal{M}} \neq \true \textup{ ou } \llbracket {\widetilde{\phi_2}}_\FOL^y \rrbracket_{\mathcal{M}} = \true \\
        \false & \textup{ sinon }
      \end{array}
             \right . \\
    & \textup{ par hypothèse de récurrence } \\
    &= \llbracket {\widetilde{\phi}}_\FOL^y \rrbracket_{\mathcal{M}}
  \end{align*}
\item
  Les cas $\phi = (\phi_1 = \phi_2)$ et $\phi = op(\vec{\phi_i})$ sont similaires.
\item
  Cas $\phi = \forall x : \psi$.
  Par définition $\phi_\FOL^y = \forall x : {\psi}_\FOL^{xy}$ et $\widetilde{\phi}_\FOL^y = \forall x : \widetilde{\psi}_\FOL^{xy}$.
  % On pose $\mathcal{M}_d = \mathcal{M}$, qui vérifie bien les hypothèses 1, 2 et 3.
  % PAS DE SENS
  Alors :
  \begin{align*}
    \llbracket \widetilde{\phi}_\FOL^y \rrbracket_{\mathcal{M}}
    &= \llbracket \forall x : \widetilde{\psi}_\FOL^{xy} \rrbracket_{\mathcal{M}} \\
    &= \left \{
      \begin{array}{l l}
        \true & \textup{ si pour } a \in \textup{dom} \mathcal{M}, \llbracket \widetilde{\psi}_\FOL^{xy} \rrbracket_{\mathcal{M}[x \mapsto a]} = \true \\
        \false & \textup{ sinon }
      \end{array}
                 \right . \\
  \end{align*}
  Pour tout $a \in \textup{dom}\mathcal{M}$ par HR il existe $\mathcal{M}_{da}$ vérifiant les différentes hypothèses par rapport à $\mathcal{M}[x \mapsto a]$.
  Tous les modèles ont alors même domaine, interprétation des opérateurs, et affectation sur les variables libres de $\widetilde{\psi}_\FOL$ excepté $x$.
  On pose $\mathcal{M}_d$ un modèle parmi les $\mathcal{M}_{da}$ (qui à $x$ associe une valeur quelconque).
  Alors pour tout $a$, $\mathcal{M}_{da} = \mathcal{M}_d[x \mapsto a]$.
  Alors :
  \begin{align*}
    \llbracket \widetilde{\phi}_\FOL^y \rrbracket_{\mathcal{M}}
    &= \left \{
      \begin{array}{l l}
        \true & \textup{ si pour } a \in \textup{dom} \mathcal{M}, \llbracket \widetilde{\psi}_\FOL^{xy} \rrbracket_{\mathcal{M}[x \mapsto a]} = \true \\
        \false & \textup{ sinon }
      \end{array}
                 \right . \\
    &= \left \{
      \begin{array}{l l}
        \true & \textup{ si pour } a \in \textup{dom} \mathcal{M}_d, \llbracket \psi_\FOL^{xy} \rrbracket_{\mathcal{M}_d[x \mapsto a]} = \true \\
        \false & \textup{ sinon }
      \end{array}
                 \right . \\
    &= \llbracket \forall x : \psi_\FOL^{xy} \rrbracket_{\mathcal{M}_d} \\
    &= \llbracket \phi_\FOL^y \rrbracket_{\mathcal{M}_d}
  \end{align*}

\item
  Cas $\phi = \nabla \psi$.
\item
  Cas $\phi = d(\vec{e_i})$.
\end{itemize}

\raph{%
  C'est dans les deux derniers cas qu'on rencontre des problèmes.}



\paragraph{Propriété 2}
Soit $d(\vec{x_i}) \triangleq e_d$ un opérateur défini, et $\phi$ une formule FOML pouvant contenir des occurences de $d$.
Si $\vDash_\FOL \phi_\FOL$ alors $\vDash_\FOL \widetilde{\phi}_\FOL$.

\paragraph{Preuve}
Pour tout modèle $\mathcal{M}$ de $\widetilde{\phi}_\FOL$ par la propriété 1 il existe $\mathcal{M}_d$ tel que
\[
  {\llbracket \widetilde{\phi}_\FOL \rrbracket}_{\mathcal{M}} = {\llbracket \phi_\FOL \rrbracket}_{\mathcal{M}_d} = tt
\]
car $\phi_\FOL$ est valide. Alors $\widetilde{\phi}_\FOL$ est valide.

\end{document}